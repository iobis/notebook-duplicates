---
title: Identifying duplicate datasets in OBIS
date: "`r Sys.Date()`"
author: Pieter Provoost
output: (function(...) {
  rmdformats::robobook(toc_depth = 4, fig_caption = FALSE, lightbox = FALSE, pandoc_args = c("+RTS", "-K2000m", "-RTS"), ...) })
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })  
---

This notebook tries to identify duplicate datasets in the OBIS system. This is done by aggregating datasets by geohash, species, and year, and calculating ~~[cosine similarities](https://en.wikipedia.org/wiki/Cosine_similarity)~~ Jaccard similarities between datasets. Skip to results [here](#results).

![grids](images/grids.png)

## Dependencies

```{r message=FALSE, warning=FALSE}
library(tidyr)
library(glue)
library(Matrix)
library(dplyr)
library(arrow)
library(dplyr)
library(data.table)
library(duckdb)
library(DBI)
library(reactable)
```

## Calculate similarities

Aggregate datasets by geohash, species, and year. Then calculate Jaccard similarity.

```{r message=FALSE, warning=FALSE, eval=FALSE}
con <- dbConnect(duckdb())

similarity <- dbGetQuery(con, glue("
  install h3 from community;
  load h3;

  WITH cells_per_dataset AS (
    SELECT DISTINCT
      dataset_id,
      concat_ws(
        '_',
        interpreted.AphiaID,
        interpreted.date_year,
        h3_latlng_to_cell_string(interpreted.decimalLatitude, interpreted.decimalLongitude, 2)
      ) as cell
    FROM read_parquet('/Volumes/acasis/occurrence/*')
  ),

  dataset_cell_counts AS (
    SELECT
      dataset_id,
      COUNT(*) as total_cells
    FROM cells_per_dataset
    GROUP BY dataset_id
  ),

  intersections AS (
    SELECT
      a.dataset_id as x,
      b.dataset_id as y,
      COUNT(*) as intersection_size
    FROM cells_per_dataset a
    JOIN cells_per_dataset b ON a.cell = b.cell
    WHERE a.dataset_id < b.dataset_id
    GROUP BY a.dataset_id, b.dataset_id
  )

  SELECT
    i.x,
    i.y,
    i.intersection_size,
    a.total_cells + b.total_cells - i.intersection_size as union_size,
    i.intersection_size::FLOAT / (a.total_cells + b.total_cells - i.intersection_size) as similarity,
    1 - (i.intersection_size::FLOAT / (a.total_cells + b.total_cells - i.intersection_size)) as distance
  FROM intersections i
  JOIN dataset_cell_counts a ON i.x = a.dataset_id
  JOIN dataset_cell_counts b ON i.y = b.dataset_id;
"))
```

Plot the similarities to get an idea of the distribution.

```{r message=FALSE, warning=FALSE}
plot(similarity$similarity)
```

Create a shortlist of suspect dataset pairs.

```{r message=FALSE, warning=FALSE}
datasets <- robis::dataset() %>%
  tidyr::unnest(statistics) %>%
  select(id, url, title, records = Occurrence)

suspect <- similarity %>%
  filter(similarity > 0.5) %>%
  left_join(datasets, by = c("x" = "id")) %>%
  left_join(datasets, by = c("y" = "id"), suffix = c("_x", "_y")) %>%
  arrange(desc(similarity), desc(records_x + records_y)) %>%
  as_tibble()

suspect 
```

## Results

```{r message=FALSE, warning=FALSE}
suspect %>%
  mutate(
    title = glue("<a href=\"https://obis.org/dataset/{x}\" target=\"_blank\">{title_x}</a><br/><br/><a href=\"https://obis.org/dataset/{y}\" target=\"_blank\">{title_y}</a>"),
    url = glue("<a href=\"{url_x}\" target=\"_blank\">{url_x}</a><br/><br/><a href=\"{url_y}\" target=\"_blank\">{url_y}</a>"),
    records = glue("{records_x}<br/><br/>{records_y}")) %>%
  select(similarity, title, url, records) %>%
  reactable(columns = list(similarity = colDef(width = 100), title = colDef(html = TRUE), url = colDef(html = TRUE), records = colDef(html = TRUE, width = 100)), pagination = FALSE)
```
